# 1. Create Request (Tabular) and Single-Step Approval

One document: principles → data load reference → plan → roadmap → DB → backend → frontend. Only what’s needed for **tabular create** and **approve/reject one request at a time**.

---

## Principles (must be clear)

1. **Scripts bypass the approval flow.**  
   The populate scripts (`0-Global Script.sql`, `1-CDI Script.sql`, etc.) insert data with **RequestStatus = 3 (Approved)** and **ApprovalStatus = 2 (Approved)**. That is for **seed/demo data only**. The scripts do not run the real workflow (LM → OLS → RLS). They are not a model for how new requests should be created in the app.

2. **Tabular entry does NOT bypass the approval flow.**  
   The new “create request (tabular)” feature is there to help users do **correct data entry** for each and every workspace. It creates a request in **Pending LM** (RequestStatus = 0). That request **must then go through the full approval flow**: LM → OLS → RLS. No back door. Tabular entry only makes it easier to enter the right fields (Workspace, RequestedFor, RequestedBy, LMApprover, RequestReason) so the request is ready for approval—it does not skip any approval step.

---

## Workspaces (each and every one)

Tabular entry and the approval flow must support **each and every workspace**. The workspace list and their RLS/SecurityType structure are defined in **`Excel/`**:

| Workspace | Source in Excel/ | SecurityType / RLS dimensions (examples) |
|-----------|-------------------|------------------------------------------|
| **CDI**   | `Excel/CDI.txt`   | Orga, PA, Client, CC, MSS, PC; Entity, PA, Client, MSS, PC, CC, SL |
| **AMER**  | `Excel/AMER`      | Same as CDI (Orga, PA, Client, CC, MSS, PC) |
| **WFI**   | `Excel/WFI.txt`   | WFI; Entity, PA (Business Areas) |
| **GI**    | `Excel/GI.txt`   | GI; Entity, Client, MSS, SL |
| **DFI**   | `Excel/DFI.txt`   | FUM; Entity, Country, Client, MSS, PC; AdditionalDetailsJSON (FlowName, etc.) |
| **EMEA**  | `Excel/EMEA.txt`  | Orga, Country, Client, CC, MSS; Entity, Country, Client, MSS, CC, SL |

- **Tabular create:** The workspace dropdown must list **all** these workspaces (from the same source as the app’s workspace list). When the user selects a workspace, data entry and any later RLS/OLS definition must follow that workspace’s structure (SecurityType and dimensions from the corresponding Excel file). Correct entry for CDI is not the same as for WFI or EMEA.
- **Approval flow:** LM → OLS → RLS applies to requests in **any** of these workspaces. Approvers are resolved per workspace (and per report/security model) as today.
- **Implementation:** Backend and frontend must not assume a single workspace or a single SecurityType. Use workspace id and, where needed, workspace type or SecurityType from `Excel/` (or from DB/API) so that each workspace is supported correctly.

---

## Dummy data and input types (what the view expects; how to add)

Below: **request-level** fields (tabular create form), then **per-workspace** example rows and how each field is expected to be entered: **Direct** (free text), **Dropdown** (fixed list), or **Lookup** (search/select from reference data).

### Request-level fields (same for all workspaces)

Used when creating a new request (tabular create). What the UI shows and how the user fills it:

| Field | Example (dummy) | Input type |
|-------|------------------|------------|
| **Workspace** | CDI | **Dropdown** (CDI, AMER, WFI, GI, DFI, EMEA) |
| **RequestedFor** | john.doe@dentsu.com | **Lookup** (employee / user) |
| **RequestedBy** | jane.admin@dentsu.com | **Lookup** or auto (current user) |
| **LMApprover** | manager@dentsu.com | **Lookup** (employee / line manager) |
| **RequestReason** | New hire access for CDI reporting | **Direct** (free text) |

**RequestCode** is **system-generated** (e.g. at DB or backend when inserting into `dbo.PermissionRequests`). The user does not enter it; the create API returns it in the response after the row is created.

---

### Per-workspace: dummy row + input type for dimensions

When adding **RLS (or OLS) details** to a request, the dimensions and SecurityType depend on the workspace. One example row per workspace and how each value is entered.

**CDI / AMER** (same structure; SecurityType: Orga, PA, Client, CC, MSS, PC)

| Dimension | Example (dummy) | Input type |
|-----------|------------------|------------|
| EntityKey | North America | **Lookup** (entity list) |
| EntityHierarchy | Cluster | **Dropdown** (Entity, BPCEntity, Market, Cluster, Region, Global, N/A) |
| PAKey | Finance | **Lookup** or **Dropdown** (Business Areas) |
| PAHierarchy | Business Functions | **Dropdown** (Overall, N/A, …) |
| ClientKey | 57 or All Clients | **Lookup** (client list) |
| ClientHierarchy | DSH / All Clients | **Dropdown** |
| MSSKey | CREATIVE | **Lookup** or **Dropdown** |
| MSSHierarchy | L1 | **Dropdown** (L4, L3, L2, L1, L0, Overall, N/A) |
| PCKey | BR_MERKLE | **Lookup** or **Dropdown** |
| PCHierarchy | BPCBrand | **Dropdown** (All PCs, N/A, …) |
| CCKey | 110 | **Lookup** or **Dropdown** |
| CCHierarchy | BPC Rollup | **Dropdown** (Business Unit, N/A, …) |
| SLKey | CXM | **Lookup** or **Dropdown** |
| SLHierarchy | Default | **Dropdown** |
| AdditionalDetailsJSON | {} | **Direct** (or leave empty) |
| SecurityType | Orga / PA / Client / CC / MSS / PC | **Dropdown** |

**WFI** (Entity + PA only; SecurityType: WFI)

| Dimension | Example (dummy) | Input type |
|-----------|------------------|------------|
| EntityKey | DACH | **Lookup** (entity list) |
| EntityHierarchy | Cluster | **Dropdown** (Entity, BPCEntity, Market, Cluster, Region, Global, N/A) |
| PAKey | CXM | **Lookup** or **Dropdown** (Business Areas) |
| PAHierarchy | Business Areas | **Dropdown** (Business Functions, Overall, N/A) |
| AdditionalDetailsJSON | {} | **Direct** (or leave empty) |
| SecurityType | WFI | **Dropdown** (fixed) |

**GI** (Entity, Client, MSS, SL; SecurityType: GI)

| Dimension | Example (dummy) | Input type |
|-----------|------------------|------------|
| EntityKey | DACH | **Lookup** (entity list) |
| EntityHierarchy | Cluster | **Dropdown** (Entity, BPCEntity, Market, Cluster, Region, Global, N/A) |
| ClientKey | 57 or All Clients | **Lookup** (client list) |
| ClientHierarchy | DSH / All Clients | **Dropdown** |
| MSSKey | CREATIVE | **Lookup** or **Dropdown** |
| MSSHierarchy | L1 | **Dropdown** (L4, L3, L2, L1, L0, Overall, N/A) |
| SLKey | TOTALPA / CRTV | **Lookup** or **Dropdown** |
| SLHierarchy | Default | **Dropdown** |
| AdditionalDetailsJSON | {} | **Direct** (or leave empty) |
| SecurityType | GI | **Dropdown** (fixed) |

**DFI (FUM)** (Entity, Country, Client, MSS, PC + AdditionalDetailsJSON)

| Dimension | Example (dummy) | Input type |
|-----------|------------------|------------|
| EntityKey | DACH | **Lookup** (entity list) |
| EntityHierarchy | Cluster | **Dropdown** (Entity, BPCEntity, Market, Cluster, Region, Global, N/A) |
| CountryKey | DEU or N/A | **Lookup** or **Dropdown** (country list) |
| CountryHierarchy | Country | **Dropdown** (Entity, Country, Cluster, Region, Global, N/A) |
| ClientKey | 57 / All Clients | **Lookup** (client list) |
| ClientHierarchy | DSH / All Clients | **Dropdown** |
| MSSKey | CREATIVE / Overall | **Lookup** or **Dropdown** |
| MSSHierarchy | L1 / Overall | **Dropdown** |
| PCKey | BR_MERKLE / All PCs | **Lookup** or **Dropdown** |
| PCHierarchy | BPCBrand / All PCs | **Dropdown** |
| AdditionalDetailsJSON | {"FlowName":"Organisation","OrgaBase":"Market",...} | **Direct** (JSON) or **structured form** (FlowName, OrgaBase, PCBrandBase, MSSBase, ClientBase) |
| SecurityType | FUM | **Dropdown** (fixed) |

**EMEA** (Entity, Country, Client, MSS, CC, SL; SecurityType: Orga, Country, Client, CC, MSS)

| Dimension | Example (dummy) | Input type |
|-----------|------------------|------------|
| EntityKey | DACH | **Lookup** (entity list) |
| EntityHierarchy | Cluster | **Dropdown** (Entity, BPCEntity, Market, Cluster, Region, Global, N/A) |
| CountryKey | DEU or N/A | **Lookup** or **Dropdown** (country list) |
| CountryHierarchy | Country | **Dropdown** (Entity, Country, Cluster, Region, Global, N/A) |
| ClientKey | 57 / All Clients | **Lookup** (client list) |
| ClientHierarchy | DSH / All Clients | **Dropdown** |
| MSSKey | CREATIVE | **Lookup** or **Dropdown** |
| MSSHierarchy | L1 | **Dropdown** (L4, L3, L2, L1, L0, Overall, N/A) |
| CCKey | Delivery Management | **Lookup** or **Dropdown** |
| CCHierarchy | Business Unit | **Dropdown** (BPC Rollup, N/A, …) |
| SLKey | CXM / Overall | **Lookup** or **Dropdown** |
| SLHierarchy | Default | **Dropdown** |
| AdditionalDetailsJSON | {} | **Direct** (or leave empty) |
| SecurityType | Orga / Country / Client / CC / MSS | **Dropdown** |

**Summary of input types**

- **Direct:** User types freely (e.g. RequestReason, AdditionalDetailsJSON).
- **Dropdown:** User picks from a fixed list (Workspace, EntityHierarchy, SecurityType, hierarchy levels like L0–L4, N/A, Overall).
- **Lookup:** User searches/selects from reference data (employees for RequestedFor/LMApprover; entities, clients, MSS, PC, CC, countries from ref/lookup tables or APIs).

The create screen (Phase 1) only needs the **request-level** fields. When the UI adds RLS/OLS detail entry per workspace, use the per-workspace tables above so each dimension is implemented as the correct control (direct, dropdown, or lookup).

---

## Data load (how it works today — reference only)

The scripts write the same tables and columns the app will use. The difference is **state**: scripts insert already-approved state; the app creates pending state and then approvals move it forward.

**Scripts:** `Script_Populate/0-Global Script.sql` inserts into `PermissionRequests` and `PermissionHeaders`. `Script_Populate/1-CDI Script.sql` (and 1-AMER, 1-GI, etc.) insert into `RLSPermission*Details` by joining on `PermissionRequests.RequestCode` → `PermissionHeaders` → `RLSPermissions`.

**Insert order in 0-Global Script.sql:**

| Step | Table | Key columns (example) |
|------|--------|------------------------|
| 1 | `dbo.PermissionRequests` | RequestCode (e.g. REQCD10001), WorkspaceId, RequestedFor, RequestedBy, **LMApprover** (from refv.Employees parent or RequestedFor), RequestStatus (0–6), RequestReason, CreatedAt, CreatedBy, UpdatedAt, UpdatedBy |
| 2 | `dbo.PermissionHeaders` | PermissionRequestId (= pr.Id), PermissionType (0=OLS, 1=RLS), ApprovalStatus (0–5), Approvers, ApprovedBy, ApprovedAt, ApproveNote, RejectedBy, RejectedAt, RejectNote, … |
| 3 | `dbo.OLSPermissions` / `dbo.RLSPermissions` | PermissionHeaderId, … |
| 4 | (in 1-CDI etc.) `RLSPermissionCDIDetails` | RLSPermissionsId, EntityKey, ClientKey, SLKey, … (joined via pr.RequestCode) |

**Scripts = bypass:** In the script, requests are inserted with **RequestStatus = 3 (Approved)** and headers with **ApprovalStatus = 2 (Approved)**. So the approval flow is skipped (seed data only).

**One example (CDI):** Request **REQCD10001** in the script → one row in `PermissionRequests` (RequestStatus=3 Approved), one row in `PermissionHeaders` (PermissionType=1 RLS, ApprovalStatus=2 Approved). Then 1-CDI inserts RLS detail rows. No LM/OLS/RLS approval steps are run.

**App (tabular + approval):** Tabular create inserts **one row** into `PermissionRequests` with **RequestStatus = 0 (Pending LM)** and optionally 1–2 rows into `PermissionHeaders` with **ApprovalStatus = 0 (Not started)** or 1 (Pending). The request then goes through the normal flow: LM approves → OLS (if any) → RLS (if any). Approve/Reject API updates the header and request status; no bypass.

---

## a) Plan end-to-end

1. **Create (tabular):** User picks **workspace** (all workspaces must be available: CDI, AMER, WFI, GI, DFI, EMEA—see `Excel/`), fills RequestedFor, RequestedBy, LMApprover, RequestReason; submits. Backend inserts **one row** into `dbo.PermissionRequests` with **RequestStatus = 0 (Pending LM)** and optionally 1–2 rows into `dbo.PermissionHeaders` (ApprovalStatus = 0 or 1). The request **does not skip approval**—it is now waiting for LM (then OLS/RLS as applicable). Tabular entry is for correct data entry **for each and every workspace**; the request then goes through the full LM → OLS → RLS flow.
2. **Details:** User opens the request (existing modal). Sees request + OLS/RLS headers. If the current user is the **LM** (RequestStatus=0) or is in a header’s **Approvers** and that header is **Pending** (ApprovalStatus=1), show **Approve** and **Reject** for that header.
3. **Approve/Reject:** User clicks, enters note (required for Reject). Backend updates that row in `dbo.PermissionHeaders` (ApprovalStatus, ApprovedBy/RejectedBy, note), then updates `dbo.PermissionRequests.RequestStatus` from the headers. Modal and list refresh. The approval flow is always followed; no bypass.

**In scope:** Tabular create API + UI (correct entry only; request starts as Pending LM); single-header approve/reject API + buttons in details modal.  
**Out of scope here:** Wizard submit, “pending for me” list, batch approve, history, delegates, existing rights, email deep link.

---

## b) Roadmap (order of work)

| Step | What |
|------|------|
| 1 | DB: add RequestCode, LMApprover to list view (so list can show them). |
| 2 | Backend: entities for base tables (write); create API; approve/reject API. |
| 3 | Frontend: create API + tabular create screen; approve/reject API + buttons in modal. |

DB first (view change). Then backend (write entities + two APIs). Then frontend (new screen + modal actions).

---

## c) DB changes

**Only one change:**

- **View `romv.PermissionRequests`**  
  Today it returns: RequestId, WorkspaceId, RequestedBy, RequestedFor, RequestStatus, OLSStatus, RLSStatus.  
  **Add to the view:** `RequestCode`, `LMApprover` from `dbo.PermissionRequests` (add to SELECT and to GROUP BY if you keep GROUP BY).

No new tables. No changes to `dbo.PermissionRequests`, `dbo.PermissionHeaders`, or `romv.PermissionHeaders`.

---

## d) Backend changes

**1. Writable entities (so we can insert/update, not only read views)**

- New entity **PermissionRequestRow** → table `dbo.PermissionRequests`: Id, RequestCode, RequestedFor, RequestedBy, LMApprover, RequestStatus, RequestReason, WorkspaceId, CreatedAt, CreatedBy, UpdatedAt, UpdatedBy.
- New entity **PermissionHeaderRow** → table `dbo.PermissionHeaders`: Id, PermissionRequestId, PermissionType, ApprovalStatus, Approvers, ApprovedBy, ApprovedAt, ApproveNote, RejectedBy, RejectedAt, RejectNote, RevokedBy, RevokedAt, RevokeNote, CreatedAt, CreatedBy, UpdatedAt, UpdatedBy.
- In **SakuraDbContext**: register both as `.ToTable(..., "dbo")`. Do **not** include them in the romv read-only rule so SaveChanges can write.

**2. Create request API (no bypass of approval flow)**

- **Request DTO:** WorkspaceId, RequestedFor, RequestedBy, LMApprover, RequestReason. No RequestCode—it is system-generated.
- **Response DTO:** Id (or RequestId), RequestCode, RequestStatus.
- **Logic:** Get current user email from `HttpContext.User`. **Generate RequestCode** (e.g. at DB level on insert or in backend before insert; must be unique). Insert one row into `dbo.PermissionRequests` with **RequestCode**, **RequestStatus = 0 (Pending LM)**, and CreatedBy/UpdatedBy = user. Optionally insert one or two rows into `dbo.PermissionHeaders` with **ApprovalStatus = 0 (Not started)** or 1 (Pending); Approvers from config or empty. Return id and RequestCode. **Do not** set RequestStatus=3 (Approved) or ApprovalStatus=2 (Approved) on create—the request must go through the real approval flow.
- **Endpoint:** `POST /api/permissions` (or `POST /api/workspaces/{workspaceId}/permissions`).
- **Validation:** WorkspaceId exists (any valid workspace: CDI, AMER, WFI, GI, DFI, EMEA, etc.); required fields not empty. RequestCode is always system-generated (e.g. in DB on insert into `dbo.PermissionRequests` or in backend before insert) and must be unique.

**3. Approve / Reject API (per header)**

- **Request DTOs:** Approve (optional Note), Reject (required Note).
- **Logic:** Get current user email. Load request + headers. Check: this header is Pending (ApprovalStatus = 1); user is LM (when RequestStatus = 0) or user is in this header’s Approvers (when OLS/RLS pending). Update the header: set ApprovalStatus, ApprovedBy/At/Note or RejectedBy/At/Note, UpdatedAt/UpdatedBy. Then set `dbo.PermissionRequests.RequestStatus` from the two headers (e.g. both approved → 3, any rejected → 4). Save.
- **Endpoints:**  
  `POST /api/permissions/requests/{permissionRequestId}/headers/{headerId}/approve`  
  `POST /api/permissions/requests/{permissionRequestId}/headers/{headerId}/reject`
- **Responses:** 403 if user not allowed, 400 if wrong state.

**4. List response (after DB view change)**

- Add **RequestCode** and **LMApprover** to **PermissionRequestsResponse** and to the mapping from the view so the list API returns them.

---

## e) Frontend changes

**1. Service and config**

- **permission-request.model.ts:** Add `CreatePermissionRequestRequest` (WorkspaceId, RequestedFor, RequestedBy, LMApprover, RequestReason). Add create response type (e.g. id, requestCode, requestStatus)—requestCode comes from backend (system-generated).
- **permission-request.service.ts:**  
  - `createRequest(req): Observable<...>` → POST create endpoint.  
  - `approveHeader(permissionRequestId, headerId, note?)`: POST approve.  
  - `rejectHeader(permissionRequestId, headerId, note)`: POST reject.
- **backend-endpoints.config.ts:** Add POST create path and POST approve/reject paths (with permissionRequestId and headerId in path).

**2. Tabular create screen**

- New route, e.g. `wso-console/permission-requests/create` (or a “New request” button that opens it).
- Purpose: help users do **correct data entry for each and every workspace** (CDI, AMER, WFI, GI, DFI, EMEA). The created request will be **Pending LM** and must go through the full approval flow—no bypass.
- Form: **Workspace** (dropdown must include **all** workspaces—see `Excel/` for the list), RequestedFor, RequestedBy, LMApprover, RequestReason. No RequestCode field—it is system-generated and returned in the create response. Submit → `createRequest(...)`. Success: toast + go to list or refresh list (list shows RequestCode from response/view). Error: show message from API.
- Use the same workspace list as the rest of the app (must cover every workspace from `Excel/`).

**3. Details modal: Approve / Reject**

- In **permission-headers-modal**: for each header with `approvalStatus === 1`, show **Approve** and **Reject**.
- Approve: optional note, then `approveHeader(requestId, header.id, note)`; then refresh details (and list if needed); toast.
- Reject: required reason, then `rejectHeader(...)`; same refresh and toast.
- Show buttons only when the current user is allowed (if backend doesn’t send a flag, you can hide for now or match same rules as backend: LM for PendingLM, or in Approvers for that header).

**4. List (after backend returns RequestCode/LMApprover)**

- Add **RequestCode** and **LMApprover** to the list model and table columns if you want them visible.

---

## Summary checklist

| Layer   | What to do |
|---------|------------|
| **DB**  | Add RequestCode, LMApprover to view `romv.PermissionRequests`. |
| **BE**  | PermissionRequestRow + PermissionHeaderRow → dbo; POST create; POST approve/reject per header; add RequestCode/LMApprover to list response. |
| **FE**  | createRequest, approveHeader, rejectHeader + endpoint config; tabular create form; Approve/Reject buttons in details modal; optional list columns. |

That’s the full plan and all changes for **Create request (tabular) and single-step approval** only.
