# 1. Create Request (Tabular) and Single-Step Approval

One document: principles → data load reference → plan → roadmap → DB → backend → frontend. Only what’s needed for **tabular create** and **approve/reject one request at a time**.

---

## Principles (must be clear)

1. **Scripts bypass the approval flow.**  
   The populate scripts (`0-Global Script.sql`, `1-CDI Script.sql`, etc.) insert data with **RequestStatus = 3 (Approved)** and **ApprovalStatus = 2 (Approved)**. That is for **seed/demo data only**. The scripts do not run the real workflow (LM → OLS → RLS). They are not a model for how new requests should be created in the app.

2. **Tabular entry does NOT bypass the approval flow.**  
   The new “create request (tabular)” feature is there to help users do **correct data entry** for each and every workspace. It creates a request in **Pending LM** (RequestStatus = 0). That request **must then go through the full approval flow**: LM → OLS → RLS. No back door. Tabular entry only makes it easier to enter the right fields (Workspace, RequestedFor, RequestedBy, LMApprover, RequestReason) so the request is ready for approval—it does not skip any approval step.

---

## Workspaces (each and every one)

Tabular entry and the approval flow must support **each and every workspace**. The workspace list and their RLS/SecurityType structure are defined in **`Excel/`**:

| Workspace | Source in Excel/ | SecurityType / RLS dimensions (examples) |
|-----------|-------------------|------------------------------------------|
| **CDI**   | `Excel/CDI.txt`   | Orga, PA, Client, CC, MSS, PC; Entity, PA, Client, MSS, PC, CC, SL |
| **AMER**  | `Excel/AMER`      | Same as CDI (Orga, PA, Client, CC, MSS, PC) |
| **WFI**   | `Excel/WFI.txt`   | WFI; Entity, PA (Business Areas) |
| **GI**    | `Excel/GI.txt`   | GI; Entity, Client, MSS, SL |
| **DFI**   | `Excel/DFI.txt`   | FUM; Entity, Country, Client, MSS, PC; AdditionalDetailsJSON (FlowName, etc.) |
| **EMEA**  | `Excel/EMEA.txt`  | Orga, Country, Client, CC, MSS; Entity, Country, Client, MSS, CC, SL |

- **Tabular create:** The workspace dropdown must list **all** these workspaces (from the same source as the app’s workspace list). When the user selects a workspace, data entry and any later RLS/OLS definition must follow that workspace’s structure (SecurityType and dimensions from the corresponding Excel file). Correct entry for CDI is not the same as for WFI or EMEA.
- **Approval flow:** LM → OLS → RLS applies to requests in **any** of these workspaces. Approvers are resolved per workspace (and per report/security model) as today.
- **Implementation:** Backend and frontend must not assume a single workspace or a single SecurityType. Use workspace id and, where needed, workspace type or SecurityType from `Excel/` (or from DB/API) so that each workspace is supported correctly.

---

## Dummy data and input types (what the view expects; how to add)

Below: **request-level** fields (tabular create form), then **per-workspace** example rows and how each field is expected to be entered: **Direct** (free text), **Dropdown** (fixed list), or **Lookup** (search/select from reference data).

### Request-level fields (same for all workspaces)

Used when creating a new request (tabular create). What the UI shows and how the user fills it:

| Field | Example (dummy) | Input type |
|-------|------------------|------------|
| **Workspace** | CDI | **Dropdown** (CDI, AMER, WFI, GI, DFI, EMEA) |
| **RequestedFor** | john.doe@dentsu.com | **Lookup** (employee / user) |
| **RequestedBy** | jane.admin@dentsu.com | **Lookup** or auto (current user) |
| **LMApprover** | manager@dentsu.com | **Lookup** (employee / line manager) |
| **RequestReason** | New hire access for CDI reporting | **Direct** (free text) |

**RequestCode** is **system-generated** (e.g. at DB or backend when inserting into `dbo.PermissionRequests`). The user does not enter it; the create API returns it in the response after the row is created.

---

### Per-workspace: dummy row + input type for dimensions

When adding **RLS (or OLS) details** to a request, the dimensions and SecurityType depend on the workspace. One example row per workspace and how each value is entered.

**CDI / AMER** (same structure; SecurityType: Orga, PA, Client, CC, MSS, PC)

| Dimension | Example (dummy) | Input type |
|-----------|------------------|------------|
| EntityKey | North America | **Lookup** (entity list) |
| EntityHierarchy | Cluster | **Dropdown** (Entity, BPCEntity, Market, Cluster, Region, Global, N/A) |
| PAKey | Finance | **Lookup** or **Dropdown** (Business Areas) |
| PAHierarchy | Business Functions | **Dropdown** (Overall, N/A, …) |
| ClientKey | 57 or All Clients | **Lookup** (client list) |
| ClientHierarchy | DSH / All Clients | **Dropdown** |
| MSSKey | CREATIVE | **Lookup** or **Dropdown** |
| MSSHierarchy | L1 | **Dropdown** (L4, L3, L2, L1, L0, Overall, N/A) |
| PCKey | BR_MERKLE | **Lookup** or **Dropdown** |
| PCHierarchy | BPCBrand | **Dropdown** (All PCs, N/A, …) |
| CCKey | 110 | **Lookup** or **Dropdown** |
| CCHierarchy | BPC Rollup | **Dropdown** (Business Unit, N/A, …) |
| SLKey | CXM | **Lookup** or **Dropdown** |
| SLHierarchy | Default | **Dropdown** |
| AdditionalDetailsJSON | {} | **Direct** (or leave empty) |
| SecurityType | Orga / PA / Client / CC / MSS / PC | **Dropdown** |

**WFI** (Entity + PA only; SecurityType: WFI)

| Dimension | Example (dummy) | Input type |
|-----------|------------------|------------|
| EntityKey | DACH | **Lookup** (entity list) |
| EntityHierarchy | Cluster | **Dropdown** (Entity, BPCEntity, Market, Cluster, Region, Global, N/A) |
| PAKey | CXM | **Lookup** or **Dropdown** (Business Areas) |
| PAHierarchy | Business Areas | **Dropdown** (Business Functions, Overall, N/A) |
| AdditionalDetailsJSON | {} | **Direct** (or leave empty) |
| SecurityType | WFI | **Dropdown** (fixed) |

**GI** (Entity, Client, MSS, SL; SecurityType: GI)

| Dimension | Example (dummy) | Input type |
|-----------|------------------|------------|
| EntityKey | DACH | **Lookup** (entity list) |
| EntityHierarchy | Cluster | **Dropdown** (Entity, BPCEntity, Market, Cluster, Region, Global, N/A) |
| ClientKey | 57 or All Clients | **Lookup** (client list) |
| ClientHierarchy | DSH / All Clients | **Dropdown** |
| MSSKey | CREATIVE | **Lookup** or **Dropdown** |
| MSSHierarchy | L1 | **Dropdown** (L4, L3, L2, L1, L0, Overall, N/A) |
| SLKey | TOTALPA / CRTV | **Lookup** or **Dropdown** |
| SLHierarchy | Default | **Dropdown** |
| AdditionalDetailsJSON | {} | **Direct** (or leave empty) |
| SecurityType | GI | **Dropdown** (fixed) |

**DFI (FUM)** (Entity, Country, Client, MSS, PC + AdditionalDetailsJSON)

| Dimension | Example (dummy) | Input type |
|-----------|------------------|------------|
| EntityKey | DACH | **Lookup** (entity list) |
| EntityHierarchy | Cluster | **Dropdown** (Entity, BPCEntity, Market, Cluster, Region, Global, N/A) |
| CountryKey | DEU or N/A | **Lookup** or **Dropdown** (country list) |
| CountryHierarchy | Country | **Dropdown** (Entity, Country, Cluster, Region, Global, N/A) |
| ClientKey | 57 / All Clients | **Lookup** (client list) |
| ClientHierarchy | DSH / All Clients | **Dropdown** |
| MSSKey | CREATIVE / Overall | **Lookup** or **Dropdown** |
| MSSHierarchy | L1 / Overall | **Dropdown** |
| PCKey | BR_MERKLE / All PCs | **Lookup** or **Dropdown** |
| PCHierarchy | BPCBrand / All PCs | **Dropdown** |
| AdditionalDetailsJSON | {"FlowName":"Organisation","OrgaBase":"Market",...} | **Direct** (JSON) or **structured form** (FlowName, OrgaBase, PCBrandBase, MSSBase, ClientBase) |
| SecurityType | FUM | **Dropdown** (fixed) |

**EMEA** (Entity, Country, Client, MSS, CC, SL; SecurityType: Orga, Country, Client, CC, MSS)

| Dimension | Example (dummy) | Input type |
|-----------|------------------|------------|
| EntityKey | DACH | **Lookup** (entity list) |
| EntityHierarchy | Cluster | **Dropdown** (Entity, BPCEntity, Market, Cluster, Region, Global, N/A) |
| CountryKey | DEU or N/A | **Lookup** or **Dropdown** (country list) |
| CountryHierarchy | Country | **Dropdown** (Entity, Country, Cluster, Region, Global, N/A) |
| ClientKey | 57 / All Clients | **Lookup** (client list) |
| ClientHierarchy | DSH / All Clients | **Dropdown** |
| MSSKey | CREATIVE | **Lookup** or **Dropdown** |
| MSSHierarchy | L1 | **Dropdown** (L4, L3, L2, L1, L0, Overall, N/A) |
| CCKey | Delivery Management | **Lookup** or **Dropdown** |
| CCHierarchy | Business Unit | **Dropdown** (BPC Rollup, N/A, …) |
| SLKey | CXM / Overall | **Lookup** or **Dropdown** |
| SLHierarchy | Default | **Dropdown** |
| AdditionalDetailsJSON | {} | **Direct** (or leave empty) |
| SecurityType | Orga / Country / Client / CC / MSS | **Dropdown** |

**Summary of input types**

- **Direct:** User types freely (e.g. RequestReason, AdditionalDetailsJSON).
- **Dropdown:** User picks from a fixed list (Workspace, EntityHierarchy, SecurityType, hierarchy levels like L0–L4, N/A, Overall).
- **Lookup:** User searches/selects from reference data (employees for RequestedFor/LMApprover; entities, clients, MSS, PC, CC, countries from ref/lookup tables or APIs).

The create screen (Phase 1) only needs the **request-level** fields. When the UI adds RLS/OLS detail entry per workspace, use the per-workspace tables above so each dimension is implemented as the correct control (direct, dropdown, or lookup).

---

## How data is added from the UI (order of entry → tables populated)

This section describes **in what order** the end user is expected to enter data through the UI, and **which DB tables** are populated. It covers `dbo.PermissionRequests`, `dbo.PermissionHeaders`, `dbo.OLSPermissions`, `dbo.RLSPermissions`, and the workspace-specific **RLSPermission*Details** tables. Examples are aligned with the structure in **`Excel/`** (CDI, AMER, WFI, GI, DFI, EMEA).

### Flow overview (all workspaces)

| Step | What user enters (UI) | Table(s) populated | Notes |
|------|------------------------|--------------------|--------|
| 1 | **Create request:** Workspace, RequestedFor, RequestedBy, LMApprover, RequestReason | `dbo.PermissionRequests` | RequestCode system-generated; RequestStatus = 0 (Pending LM); WorkspaceId from Workspace. |
| 2 | (Same submit or after) | `dbo.PermissionHeaders` | 1 or 2 rows: PermissionType 0 = OLS, 1 = RLS; ApprovalStatus 0 or 1; linked by PermissionRequestId. |
| 3 | If OLS: OLS item (e.g. report/audience) | `dbo.OLSPermissions` | PermissionHeaderId (OLS header); OLSItemType, OLSItemId; optional AdditionalDetailsJSON. |
| 4 | If RLS: Security model + SecurityType + dimensions (per workspace) | `dbo.RLSPermissions` | PermissionHeaderId (RLS header); SecurityModelId, SecurityTypeLoVId; optional AdditionalDetailsJSON. |
| 5 | Same RLS entry: dimension keys/hierarchies | `dbo.RLSPermission*Details` | One table per workspace (see below); RLSPermissionsId; dimension columns from Excel. |

**Single flow per request:** For each workspace, we take the **whole data in a single flow**. The user fills request-level fields (Workspace, RequestedFor, RequestedBy, LMApprover, RequestReason) and all RLS dimension fields for that workspace in one form/screen; one submit then creates the request, headers, RLSPermissions, and RLSPermission*Details rows together. So: **yes**, the entire data for one permission request is captured in one flow.

### Table → workspace mapping for RLS details

| Workspace | RLS Details table | Key columns (from DB; see Excel for semantics) |
|-----------|-------------------|------------------------------------------------|
| CDI | `dbo.RLSPermissionCDIDetails` | EntityKey, EntityHierarchy, ClientKey, ClientHierarchy, SLKey, SLHierarchy |
| AMER | `dbo.RLSPermissionAMERDetails` | EntityKey, EntityHierarchy, SLKey, SLHierarchy, ClientKey, ClientHierarchy, PCKey, PCHierarchy, CCKey, CCHierarchy, PAKey, PAHierarchy, MSSKey, MSSHierarchy |
| WFI | `dbo.RLSPermissionWFIDetails` | EntityKey, EntityHierarchy, PAKey, PAHierarchy |
| GI | `dbo.RLSPermissionGIDetails` | EntityKey, EntityHierarchy, ClientKey, ClientHierarchy, MSSKey, MSSHierarchy, SLKey, SLHierarchy |
| DFI (FUM) | `dbo.RLSPermissionFUMDetails` | EntityKey, EntityHierarchy, CountryKey, CountryHierarchy, ClientKey, ClientHierarchy, MSSKey, MSSHierarchy, ProfitCenterKey, ProfitCenterHierarchy |
| EMEA | `dbo.RLSPermissionEMEADetails` | EntityKey, EntityHierarchy, SLKey, SLHierarchy, ClientKey, ClientHierarchy, CCKey, CCHierarchy, CountryKey, CountryHierarchy, MSSKey, MSSHierarchy |

(DFI DB table uses **ProfitCenterKey** / **ProfitCenterHierarchy**; Excel/UI may show these as PCKey/PCHierarchy—same values.)

---

### Column reference: count, type, and how populated

For each table written in the single flow: **number of columns** (that receive data), **column name**, **DB type**, and **how the data is populated** (User = from form; System = generated/default; Lookup = from ref/workspace; From parent = from newly created row).

#### dbo.PermissionRequests (11 columns populated; Id is IDENTITY)

| # | Column | DB type | How populated |
|---|--------|---------|----------------|
| 1 | RequestCode | NVARCHAR(50) | **System** (generated on insert) |
| 2 | RequestedFor | NVARCHAR(255) | **User** (lookup: employee) |
| 3 | RequestedBy | NVARCHAR(255) | **User** (lookup or current user) |
| 4 | LMApprover | NVARCHAR(255) | **User** (lookup: employee) |
| 5 | RequestStatus | INT | **System** (0 = Pending LM on create) |
| 6 | RequestReason | NVARCHAR(255) | **User** (direct text) |
| 7 | WorkspaceId | INT | **Lookup** (from Workspace selected by user) |
| 8 | CreatedAt | DATETIME2(0) | **System** (e.g. GETUTCDATE()) |
| 9 | CreatedBy | NVARCHAR(255) | **System** (current user) |
| 10 | UpdatedAt | DATETIME2(0) | **System** |
| 11 | UpdatedBy | NVARCHAR(255) | **System** (current user) |

#### dbo.PermissionHeaders (16 columns populated per header; Id is IDENTITY)

| # | Column | DB type | How populated |
|---|--------|---------|----------------|
| 1 | PermissionRequestId | INT | **From parent** (Id of new PermissionRequests row) |
| 2 | PermissionType | INT | **System** (1 for RLS header) |
| 3 | ApprovalStatus | INT | **System** (0 or 1 on create) |
| 4 | Approvers | NVARCHAR(1024) | **System** or config (e.g. empty or from config) |
| 5 | ApprovedBy, ApprovedAt, ApproveNote | NVARCHAR/DATETIME2 | NULL until approved |
| 6 | RejectedBy, RejectedAt, RejectNote | NVARCHAR/DATETIME2 | NULL |
| 7 | RevokedBy, RevokedAt, RevokeNote | NVARCHAR/DATETIME2 | NULL |
| 8 | CreatedAt, CreatedBy, UpdatedAt, UpdatedBy | DATETIME2/NVARCHAR | **System** |

#### dbo.RLSPermissions (7 columns populated; Id is IDENTITY)

| # | Column | DB type | How populated |
|---|--------|---------|----------------|
| 1 | PermissionHeaderId | INT | **From parent** (Id of new RLS PermissionHeaders row) |
| 2 | SecurityModelId | INT | **Lookup** (from workspace + security model, e.g. WorkspaceSecurityModels) |
| 3 | SecurityTypeLoVId | INT | **Lookup** (from user’s SecurityType selection → LoVs) |
| 4 | AdditionalDetailsJSON | NVARCHAR(2048) | **User** (e.g. DFI: FlowName, OrgaBase, PCBrandBase, MSSBase, ClientBase) or {} |
| 5 | CreatedAt, CreatedBy, UpdatedAt, UpdatedBy | DATETIME2/NVARCHAR | **System** |

#### dbo.RLSPermissionCDIDetails (11 columns populated; Id is IDENTITY)

| # | Column | DB type | How populated |
|---|--------|---------|----------------|
| 1 | RLSPermissionsId | INT | **From parent** (Id of new RLSPermissions row) |
| 2 | EntityKey | NVARCHAR(255) | **User** (lookup/dropdown) |
| 3 | EntityHierarchy | NVARCHAR(50) | **User** (dropdown) |
| 4 | ClientKey | NVARCHAR(255) | **User** (lookup/dropdown) |
| 5 | ClientHierarchy | NVARCHAR(50) | **User** (dropdown) |
| 6 | SLKey | NVARCHAR(255) | **User** (lookup/dropdown) |
| 7 | SLHierarchy | NVARCHAR(50) | **User** (dropdown) |
| 8 | CreatedAt, CreatedBy, UpdatedAt, UpdatedBy | DATETIME2/NVARCHAR | **System** |

#### dbo.RLSPermissionAMERDetails (19 columns populated; Id is IDENTITY)

| # | Column | DB type | How populated |
|---|--------|---------|----------------|
| 1 | RLSPermissionsId | INT | **From parent** |
| 2 | EntityKey, EntityHierarchy | NVARCHAR(255/50) | **User** |
| 3 | SLKey, SLHierarchy | NVARCHAR(255/50) | **User** |
| 4 | ClientKey, ClientHierarchy | NVARCHAR(255/50) | **User** |
| 5 | PCKey, PCHierarchy | NVARCHAR(255/50) | **User** |
| 6 | CCKey, CCHierarchy | NVARCHAR(255/50) | **User** |
| 7 | PAKey, PAHierarchy | NVARCHAR(255/50) | **User** |
| 8 | MSSKey, MSSHierarchy | NVARCHAR(255/50) | **User** |
| 9 | CreatedAt, CreatedBy, UpdatedAt, UpdatedBy | DATETIME2/NVARCHAR | **System** |

#### dbo.RLSPermissionWFIDetails (9 columns populated; Id is IDENTITY)

| # | Column | DB type | How populated |
|---|--------|---------|----------------|
| 1 | RLSPermissionsId | INT | **From parent** |
| 2 | EntityKey, EntityHierarchy | NVARCHAR(255/50) | **User** |
| 3 | PAKey, PAHierarchy | NVARCHAR(255/50) | **User** |
| 4 | CreatedAt, CreatedBy, UpdatedAt, UpdatedBy | DATETIME2/NVARCHAR | **System** |

#### dbo.RLSPermissionGIDetails (13 columns populated; Id is IDENTITY)

| # | Column | DB type | How populated |
|---|--------|---------|----------------|
| 1 | RLSPermissionsId | INT | **From parent** |
| 2 | EntityKey, EntityHierarchy | NVARCHAR(255/50) | **User** |
| 3 | ClientKey, ClientHierarchy | NVARCHAR(255/50) | **User** |
| 4 | MSSKey, MSSHierarchy | NVARCHAR(255/50) | **User** |
| 5 | SLKey, SLHierarchy | NVARCHAR(255/50) | **User** |
| 6 | CreatedAt, CreatedBy, UpdatedAt, UpdatedBy | DATETIME2/NVARCHAR | **System** |

#### dbo.RLSPermissionFUMDetails (15 columns populated; Id is IDENTITY)

| # | Column | DB type | How populated |
|---|--------|---------|----------------|
| 1 | RLSPermissionsId | INT | **From parent** |
| 2 | EntityKey | NVARCHAR(255) | **User** |
| 3 | EntityHierarchy | NVARCHAR(50) | **User** |
| 4 | CountryKey | NVARCHAR(255) | **User** (or N/A) |
| 5 | CountryHierarchy | NVARCHAR(50) | **User** |
| 6 | ClientKey | NVARCHAR(255) | **User** |
| 7 | ClientHierarchy | NVARCHAR(50) | **User** |
| 8 | MSSKey | NVARCHAR(255) | **User** |
| 9 | MSSHierarchy | NVARCHAR(50) | **User** |
| 10 | ProfitCenterKey | NVARCHAR(255) | **User** |
| 11 | ProfitCenterHierarchy | NVARCHAR(50) | **User** |
| 12 | CreatedAt, CreatedBy, UpdatedAt, UpdatedBy | DATETIME2/NVARCHAR | **System** |

#### dbo.RLSPermissionEMEADetails (17 columns populated; Id is IDENTITY)

| # | Column | DB type | How populated |
|---|--------|---------|----------------|
| 1 | RLSPermissionsId | INT | **From parent** |
| 2 | EntityKey, EntityHierarchy | NVARCHAR(255/50) | **User** |
| 3 | SLKey, SLHierarchy | NVARCHAR(255/50) | **User** |
| 4 | ClientKey, ClientHierarchy | NVARCHAR(255/50) | **User** |
| 5 | CCKey, CCHierarchy | NVARCHAR(255/50) | **User** |
| 6 | CountryKey, CountryHierarchy | NVARCHAR(255/50) | **User** |
| 7 | MSSKey, MSSHierarchy | NVARCHAR(255/50) | **User** |
| 8 | CreatedAt, CreatedBy, UpdatedAt, UpdatedBy | DATETIME2/NVARCHAR | **System** |

---

### Per-workspace: one example from Excel and full chain (UI → tables)

For each workspace, one **example row** from the Excel structure is given. The “User enters” column is the **order** of data the end user is expected to provide; “Populates” shows which table and columns get that value.

#### CDI (source: `Excel/CDI.txt`)

Example scenario: *Client Specific Access* — Entity LATAM/Cluster, Client 57/DSH, SL CRTV/Default, SecurityType Client.

| # | User enters (in order) | Populates |
|---|------------------------|-----------|
| 1 | Workspace = CDI | `PermissionRequests.WorkspaceId` |
| 2 | RequestedFor, RequestedBy, LMApprover, RequestReason | `PermissionRequests` (RequestedFor, RequestedBy, LMApprover, RequestReason); RequestCode system-generated |
| 3 | (Submit request) | `PermissionHeaders` (e.g. one RLS header: PermissionType=1, ApprovalStatus=0 or 1) |
| 4 | SecurityType = Client (for RLS) | `RLSPermissions.SecurityTypeLoVId` (+ SecurityModelId from workspace); `RLSPermissions.AdditionalDetailsJSON` if used |
| 5 | EntityKey = LATAM, EntityHierarchy = Cluster | `RLSPermissionCDIDetails`: EntityKey, EntityHierarchy |
| 6 | ClientKey = 57, ClientHierarchy = DSH | `RLSPermissionCDIDetails`: ClientKey, ClientHierarchy |
| 7 | SLKey = CRTV, SLHierarchy = Default | `RLSPermissionCDIDetails`: SLKey, SLHierarchy |

**Result:** 1 row in `PermissionRequests`, 1 row in `PermissionHeaders` (RLS), 1 row in `RLSPermissions`, 1 row in `RLSPermissionCDIDetails`.

---

#### AMER (source: `Excel/AMER`)

Same shape as CDI; example: *PC Access* — North America/Cluster, All Clients, BR_MERKLE/BPCBrand, CXM/Default, SecurityType PC.

| # | User enters (in order) | Populates |
|---|------------------------|-----------|
| 1 | Workspace = AMER | `PermissionRequests.WorkspaceId` |
| 2 | RequestedFor, RequestedBy, LMApprover, RequestReason | `PermissionRequests` |
| 3 | (Submit request) | `PermissionHeaders` (RLS header) |
| 4 | SecurityType = PC | `RLSPermissions` (SecurityTypeLoVId, SecurityModelId, AdditionalDetailsJSON) |
| 5 | EntityKey = North America, EntityHierarchy = Cluster | `RLSPermissionAMERDetails`: EntityKey, EntityHierarchy |
| 6 | SLKey = CXM, SLHierarchy = Default | `RLSPermissionAMERDetails`: SLKey, SLHierarchy |
| 7 | ClientKey = All Clients, ClientHierarchy = All Clients | `RLSPermissionAMERDetails`: ClientKey, ClientHierarchy |
| 8 | PCKey = BR_MERKLE, PCHierarchy = BPCBrand | `RLSPermissionAMERDetails`: PCKey, PCHierarchy |
| 9 | CCKey, CCHierarchy, PAKey, PAHierarchy, MSSKey, MSSHierarchy (or N/A) | `RLSPermissionAMERDetails`: same columns |

**Result:** 1 row in `PermissionRequests`, 1 in `PermissionHeaders`, 1 in `RLSPermissions`, 1 in `RLSPermissionAMERDetails`.

---

#### WFI (source: `Excel/WFI.txt`)

Example: *Cluster PA* — DACH/Cluster, CXM/Business Areas, SecurityType WFI.

| # | User enters (in order) | Populates |
|---|------------------------|-----------|
| 1 | Workspace = WFI | `PermissionRequests.WorkspaceId` |
| 2 | RequestedFor, RequestedBy, LMApprover, RequestReason | `PermissionRequests` |
| 3 | (Submit request) | `PermissionHeaders` (RLS header) |
| 4 | SecurityType = WFI | `RLSPermissions` |
| 5 | EntityKey = DACH, EntityHierarchy = Cluster | `RLSPermissionWFIDetails`: EntityKey, EntityHierarchy |
| 6 | PAKey = CXM, PAHierarchy = Business Areas | `RLSPermissionWFIDetails`: PAKey, PAHierarchy |

**Result:** 1 row in `PermissionRequests`, 1 in `PermissionHeaders`, 1 in `RLSPermissions`, 1 in `RLSPermissionWFIDetails`.

---

#### GI (source: `Excel/GI.txt`)

Example: *Cluster Practice DSH Client Access* — DACH/Cluster, 57/DSH, CREATIVE/L1, TOTALPA/Default, SecurityType GI.

| # | User enters (in order) | Populates |
|---|------------------------|-----------|
| 1 | Workspace = GI | `PermissionRequests.WorkspaceId` |
| 2 | RequestedFor, RequestedBy, LMApprover, RequestReason | `PermissionRequests` |
| 3 | (Submit request) | `PermissionHeaders` (RLS header) |
| 4 | SecurityType = GI | `RLSPermissions` |
| 5 | EntityKey = DACH, EntityHierarchy = Cluster | `RLSPermissionGIDetails`: EntityKey, EntityHierarchy |
| 6 | ClientKey = 57, ClientHierarchy = DSH | `RLSPermissionGIDetails`: ClientKey, ClientHierarchy |
| 7 | MSSKey = CREATIVE, MSSHierarchy = L1 | `RLSPermissionGIDetails`: MSSKey, MSSHierarchy |
| 8 | SLKey = TOTALPA, SLHierarchy = Default | `RLSPermissionGIDetails`: SLKey, SLHierarchy |

**Result:** 1 row in `PermissionRequests`, 1 in `PermissionHeaders`, 1 in `RLSPermissions`, 1 in `RLSPermissionGIDetails`.

---

#### DFI / FUM (source: `Excel/DFI.txt`)

Example: *Cluster Practice Client Brand Access* — DACH/Cluster, 224555/Client, Overall/Overall, BR_MERKLE/BPCBrand, AdditionalDetailsJSON with FlowName/MSS/etc., SecurityType FUM.

| # | User enters (in order) | Populates |
|---|------------------------|-----------|
| 1 | Workspace = DFI | `PermissionRequests.WorkspaceId` |
| 2 | RequestedFor, RequestedBy, LMApprover, RequestReason | `PermissionRequests` |
| 3 | (Submit request) | `PermissionHeaders` (RLS header) |
| 4 | SecurityType = FUM, AdditionalDetailsJSON (e.g. FlowName, OrgaBase, PCBrandBase, MSSBase, ClientBase) | `RLSPermissions` (SecurityTypeLoVId, SecurityModelId, AdditionalDetailsJSON) |
| 5 | EntityKey = DACH, EntityHierarchy = Cluster | `RLSPermissionFUMDetails`: EntityKey, EntityHierarchy |
| 6 | CountryKey, CountryHierarchy (or N/A) | `RLSPermissionFUMDetails`: CountryKey, CountryHierarchy |
| 7 | ClientKey = 224555, ClientHierarchy = Client | `RLSPermissionFUMDetails`: ClientKey, ClientHierarchy |
| 8 | MSSKey = Overall, MSSHierarchy = Overall | `RLSPermissionFUMDetails`: MSSKey, MSSHierarchy |
| 9 | ProfitCenterKey = BR_MERKLE, ProfitCenterHierarchy = BPCBrand | `RLSPermissionFUMDetails`: ProfitCenterKey, ProfitCenterHierarchy |

**Result:** 1 row in `PermissionRequests`, 1 in `PermissionHeaders`, 1 in `RLSPermissions`, 1 in `RLSPermissionFUMDetails`.

---

#### EMEA (source: `Excel/EMEA.txt`)

Example: *CC Access* — D365 entity, Delivery Management/Business Unit, CXM/Default, SecurityType CC; or *Client Specific Access* — DACH/Cluster, 57/DSH, CRTV/Default, SecurityType Client.

| # | User enters (in order) | Populates |
|---|------------------------|-----------|
| 1 | Workspace = EMEA | `PermissionRequests.WorkspaceId` |
| 2 | RequestedFor, RequestedBy, LMApprover, RequestReason | `PermissionRequests` |
| 3 | (Submit request) | `PermissionHeaders` (RLS header) |
| 4 | SecurityType = Orga / Country / Client / CC / MSS | `RLSPermissions` |
| 5 | EntityKey, EntityHierarchy | `RLSPermissionEMEADetails`: EntityKey, EntityHierarchy |
| 6 | CountryKey, CountryHierarchy (or N/A) | `RLSPermissionEMEADetails`: CountryKey, CountryHierarchy |
| 7 | ClientKey, ClientHierarchy | `RLSPermissionEMEADetails`: ClientKey, ClientHierarchy |
| 8 | MSSKey, MSSHierarchy | `RLSPermissionEMEADetails`: MSSKey, MSSHierarchy |
| 9 | CCKey, CCHierarchy | `RLSPermissionEMEADetails`: CCKey, CCHierarchy |
| 10 | SLKey = CXM, SLHierarchy = Default | `RLSPermissionEMEADetails`: SLKey, SLHierarchy |

**Result:** 1 row in `PermissionRequests`, 1 in `PermissionHeaders`, 1 in `RLSPermissions`, 1 in `RLSPermissionEMEADetails`.

---

### Summary: data added from UI

- **Single flow:** For each workspace, all data for one permission request (request-level + RLS dimensions) is taken in **one flow**; one submit populates PermissionRequests, PermissionHeaders, RLSPermissions, and the workspace’s RLSPermission*Details table.
- **Request (all workspaces):** User provides Workspace, RequestedFor, RequestedBy, LMApprover, RequestReason. System generates RequestCode. Backend writes **PermissionRequests** and **PermissionHeaders** (and optionally OLS/RLS rows).
- **RLS (per workspace):** User provides SecurityType and the dimension keys/hierarchies listed in the table above for that workspace. Backend resolves SecurityModelId and SecurityTypeLoVId, inserts **RLSPermissions**, then inserts one or more rows into the correct **RLSPermission*Details** table (CDI, AMER, WFI, GI, FUM, EMEA) with the dimension values.
- **OLS (if applicable):** User provides OLS item (e.g. report or audience); backend writes **OLSPermissions** linked to the OLS PermissionHeader.

The Excel files in **`Excel/`** define the exact column names and example values for each workspace; the DB tables and scripts (`Script_Populate/0-Global Script.sql`, `1-CDI Script.sql`, etc.) implement the same structure.

---

## Data load (how it works today — reference only)

The scripts write the same tables and columns the app will use. The difference is **state**: scripts insert already-approved state; the app creates pending state and then approvals move it forward.

**Scripts:** `Script_Populate/0-Global Script.sql` inserts into `PermissionRequests` and `PermissionHeaders`. `Script_Populate/1-CDI Script.sql` (and 1-AMER, 1-GI, etc.) insert into `RLSPermission*Details` by joining on `PermissionRequests.RequestCode` → `PermissionHeaders` → `RLSPermissions`.

**Insert order in 0-Global Script.sql:**

| Step | Table | Key columns (example) |
|------|--------|------------------------|
| 1 | `dbo.PermissionRequests` | RequestCode (e.g. REQCD10001), WorkspaceId, RequestedFor, RequestedBy, **LMApprover** (from refv.Employees parent or RequestedFor), RequestStatus (0–6), RequestReason, CreatedAt, CreatedBy, UpdatedAt, UpdatedBy |
| 2 | `dbo.PermissionHeaders` | PermissionRequestId (= pr.Id), PermissionType (0=OLS, 1=RLS), ApprovalStatus (0–5), Approvers, ApprovedBy, ApprovedAt, ApproveNote, RejectedBy, RejectedAt, RejectNote, … |
| 3 | `dbo.OLSPermissions` / `dbo.RLSPermissions` | PermissionHeaderId, … |
| 4 | (in 1-CDI etc.) `RLSPermissionCDIDetails` | RLSPermissionsId, EntityKey, ClientKey, SLKey, … (joined via pr.RequestCode) |

**Scripts = bypass:** In the script, requests are inserted with **RequestStatus = 3 (Approved)** and headers with **ApprovalStatus = 2 (Approved)**. So the approval flow is skipped (seed data only).

**One example (CDI):** Request **REQCD10001** in the script → one row in `PermissionRequests` (RequestStatus=3 Approved), one row in `PermissionHeaders` (PermissionType=1 RLS, ApprovalStatus=2 Approved). Then 1-CDI inserts RLS detail rows. No LM/OLS/RLS approval steps are run.

**App (tabular + approval):** Tabular create inserts **one row** into `PermissionRequests` with **RequestStatus = 0 (Pending LM)** and optionally 1–2 rows into `PermissionHeaders` with **ApprovalStatus = 0 (Not started)** or 1 (Pending). The request then goes through the normal flow: LM approves → OLS (if any) → RLS (if any). Approve/Reject API updates the header and request status; no bypass.

---

## a) Plan end-to-end

1. **Create (tabular):** User picks **workspace** (all workspaces must be available: CDI, AMER, WFI, GI, DFI, EMEA—see `Excel/`), fills RequestedFor, RequestedBy, LMApprover, RequestReason; submits. Backend inserts **one row** into `dbo.PermissionRequests` with **RequestStatus = 0 (Pending LM)** and optionally 1–2 rows into `dbo.PermissionHeaders` (ApprovalStatus = 0 or 1). The request **does not skip approval**—it is now waiting for LM (then OLS/RLS as applicable). Tabular entry is for correct data entry **for each and every workspace**; the request then goes through the full LM → OLS → RLS flow.
2. **Details:** User opens the request (existing modal). Sees request + OLS/RLS headers. If the current user is the **LM** (RequestStatus=0) or is in a header’s **Approvers** and that header is **Pending** (ApprovalStatus=1), show **Approve** and **Reject** for that header.
3. **Approve/Reject:** User clicks, enters note (required for Reject). Backend updates that row in `dbo.PermissionHeaders` (ApprovalStatus, ApprovedBy/RejectedBy, note), then updates `dbo.PermissionRequests.RequestStatus` from the headers. Modal and list refresh. The approval flow is always followed; no bypass.

**In scope:** Tabular create API + UI (correct entry only; request starts as Pending LM); single-header approve/reject API + buttons in details modal.  
**Out of scope here:** Wizard submit, “pending for me” list, batch approve, history, delegates, existing rights, email deep link.

---

## b) Roadmap (order of work)

| Step | What |
|------|------|
| 1 | DB: add RequestCode, LMApprover to list view (so list can show them). |
| 2 | Backend: entities for base tables (write); create API; approve/reject API. |
| 3 | Frontend: create API + tabular create screen; approve/reject API + buttons in modal. |

DB first (view change). Then backend (write entities + two APIs). Then frontend (new screen + modal actions).

---

## c) DB changes

**Only one change:**

- **View `romv.PermissionRequests`**  
  Today it returns: RequestId, WorkspaceId, RequestedBy, RequestedFor, RequestStatus, OLSStatus, RLSStatus.  
  **Add to the view:** `RequestCode`, `LMApprover` from `dbo.PermissionRequests` (add to SELECT and to GROUP BY if you keep GROUP BY).

No new tables. No changes to `dbo.PermissionRequests`, `dbo.PermissionHeaders`, or `romv.PermissionHeaders`.

---

## d) Backend changes

**1. Writable entities (so we can insert/update, not only read views)**

- New entity **PermissionRequestRow** → table `dbo.PermissionRequests`: Id, RequestCode, RequestedFor, RequestedBy, LMApprover, RequestStatus, RequestReason, WorkspaceId, CreatedAt, CreatedBy, UpdatedAt, UpdatedBy.
- New entity **PermissionHeaderRow** → table `dbo.PermissionHeaders`: Id, PermissionRequestId, PermissionType, ApprovalStatus, Approvers, ApprovedBy, ApprovedAt, ApproveNote, RejectedBy, RejectedAt, RejectNote, RevokedBy, RevokedAt, RevokeNote, CreatedAt, CreatedBy, UpdatedAt, UpdatedBy.
- In **SakuraDbContext**: register both as `.ToTable(..., "dbo")`. Do **not** include them in the romv read-only rule so SaveChanges can write.

**2. Create request API (no bypass of approval flow)**

- **Request DTO:** WorkspaceId, RequestedFor, RequestedBy, LMApprover, RequestReason. No RequestCode—it is system-generated.
- **Response DTO:** Id (or RequestId), RequestCode, RequestStatus.
- **Logic:** Get current user email from `HttpContext.User`. **Generate RequestCode** (e.g. at DB level on insert or in backend before insert; must be unique). Insert one row into `dbo.PermissionRequests` with **RequestCode**, **RequestStatus = 0 (Pending LM)**, and CreatedBy/UpdatedBy = user. Optionally insert one or two rows into `dbo.PermissionHeaders` with **ApprovalStatus = 0 (Not started)** or 1 (Pending); Approvers from config or empty. Return id and RequestCode. **Do not** set RequestStatus=3 (Approved) or ApprovalStatus=2 (Approved) on create—the request must go through the real approval flow.
- **Endpoint:** `POST /api/permissions` (or `POST /api/workspaces/{workspaceId}/permissions`).
- **Validation:** WorkspaceId exists (any valid workspace: CDI, AMER, WFI, GI, DFI, EMEA, etc.); required fields not empty. RequestCode is always system-generated (e.g. in DB on insert into `dbo.PermissionRequests` or in backend before insert) and must be unique.

**3. Approve / Reject API (per header)**

- **Request DTOs:** Approve (optional Note), Reject (required Note).
- **Logic:** Get current user email. Load request + headers. Check: this header is Pending (ApprovalStatus = 1); user is LM (when RequestStatus = 0) or user is in this header’s Approvers (when OLS/RLS pending). Update the header: set ApprovalStatus, ApprovedBy/At/Note or RejectedBy/At/Note, UpdatedAt/UpdatedBy. Then set `dbo.PermissionRequests.RequestStatus` from the two headers (e.g. both approved → 3, any rejected → 4). Save.
- **Endpoints:**  
  `POST /api/permissions/requests/{permissionRequestId}/headers/{headerId}/approve`  
  `POST /api/permissions/requests/{permissionRequestId}/headers/{headerId}/reject`
- **Responses:** 403 if user not allowed, 400 if wrong state.

**4. List response (after DB view change)**

- Add **RequestCode** and **LMApprover** to **PermissionRequestsResponse** and to the mapping from the view so the list API returns them.

---

## e) Frontend changes

**1. Service and config**

- **permission-request.model.ts:** Add `CreatePermissionRequestRequest` (WorkspaceId, RequestedFor, RequestedBy, LMApprover, RequestReason). Add create response type (e.g. id, requestCode, requestStatus)—requestCode comes from backend (system-generated).
- **permission-request.service.ts:**  
  - `createRequest(req): Observable<...>` → POST create endpoint.  
  - `approveHeader(permissionRequestId, headerId, note?)`: POST approve.  
  - `rejectHeader(permissionRequestId, headerId, note)`: POST reject.
- **backend-endpoints.config.ts:** Add POST create path and POST approve/reject paths (with permissionRequestId and headerId in path).

**2. Tabular create screen**

- New route, e.g. `wso-console/permission-requests/create` (or a “New request” button that opens it).
- Purpose: help users do **correct data entry for each and every workspace** (CDI, AMER, WFI, GI, DFI, EMEA). The created request will be **Pending LM** and must go through the full approval flow—no bypass.
- Form: **Workspace** (dropdown must include **all** workspaces—see `Excel/` for the list), RequestedFor, RequestedBy, LMApprover, RequestReason. No RequestCode field—it is system-generated and returned in the create response. Submit → `createRequest(...)`. Success: toast + go to list or refresh list (list shows RequestCode from response/view). Error: show message from API.
- Use the same workspace list as the rest of the app (must cover every workspace from `Excel/`).

**3. Details modal: Approve / Reject**

- In **permission-headers-modal**: for each header with `approvalStatus === 1`, show **Approve** and **Reject**.
- Approve: optional note, then `approveHeader(requestId, header.id, note)`; then refresh details (and list if needed); toast.
- Reject: required reason, then `rejectHeader(...)`; same refresh and toast.
- Show buttons only when the current user is allowed (if backend doesn’t send a flag, you can hide for now or match same rules as backend: LM for PendingLM, or in Approvers for that header).

**4. List (after backend returns RequestCode/LMApprover)**

- Add **RequestCode** and **LMApprover** to the list model and table columns if you want them visible.

---

## Summary checklist

| Layer   | What to do |
|---------|------------|
| **DB**  | Add RequestCode, LMApprover to view `romv.PermissionRequests`. |
| **BE**  | PermissionRequestRow + PermissionHeaderRow → dbo; POST create; POST approve/reject per header; add RequestCode/LMApprover to list response. |
| **FE**  | createRequest, approveHeader, rejectHeader + endpoint config; tabular create form; Approve/Reject buttons in details modal; optional list columns. |

That’s the full plan and all changes for **Create request (tabular) and single-step approval** only.
